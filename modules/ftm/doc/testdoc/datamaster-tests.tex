\documentclass[12pt,a4paper]{report}
% Language: English
\pdfminorversion=7
\usepackage[pdftex]{graphicx}
\usepackage{changepage}
\usepackage{xcolor}
\usepackage{listings}

\lstdefinestyle{dotfiles}{
  escapeinside={(*@}{@*)}, % (*@\label{mylabel}@*)
  numbers=left,
  stepnumber=1,
  numberstyle=\tiny,
  numbersep=10pt,
  captionpos=b,
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  keepspaces=true,
  columns=flexible,
  language=C,
  showstringspaces=false,
  basicstyle=\scriptsize\ttfamily,
  keywordstyle=\color{green!40!black},
  commentstyle=\itshape\color{purple!40!black},
  identifierstyle=\color{blue},
  stringstyle=\color{red},
  tabsize=2,
  morekeywords={digraph, graph, subgraph, edge, node, color, style, shape, fillcolor},
}

\newcommand{\ry}{\rotatebox{90}}
\begin{document}

\begin{titlepage}
\vspace{2cm}
\begin{center}
\Huge{Tests for the Datamaster}

\Large{Martin Skorsky}

\Large{2020-12-23}
\end{center}
\vfill
\end{titlepage}

\tableofcontents

\chapter{Overview - What is tested}
All tests are on branch \texttt{dm-fallout-tests}. The tests run with \texttt{make} or \texttt{make all} in folder \texttt{modules/ftm/tests}.
To compile \texttt{libcarpedm} use \texttt{make prepare}. This runs \texttt{make clean} and \texttt{make} in folder \texttt{modules/ftm/ftmx86}.

Each test has a seperate target in the \texttt{Makefile}.
\begin{table}
\caption{Which test tests what}
%\begin{center}
\centering
\begin{tabular}[t]{|l|c|c|c|c|c|c|c|c|}
\hline
Test           & \ry{Tools} & \ry{libcarpedm} & \ry{firmware} & \ry{DM-Wrapper } & \ry{uses Python} & \ry{common} & \ry{make} & \ry{checks result} \\ \hline
bpcStart       &   -        &   T             &   x           &   x              &   x              &   x         &   -       &   x                \\ \hline
dmPerformance  &   x        &   T             &   x           &   -              &   -              &   -         &   x       &   -                \\ \hline
dmThreads      &   x        &   x             &   T           &   -              &   -              &   -         &   x       &   -                \\ \hline
fid7           &   -        &   x             &   T           &   x              &   x              &   x         &   -       &   x                \\ \hline
full\_test     &   -        &   T             &   x           &   -              &   x              &   -         &   -       &   x                \\ \hline
messageCounter &   -        &   x             &   x           &   T              &   x              &   -         &   -       &   -                \\ \hline
pps            &   -        &   T             &   x           &   x              &   x              &   -         &   -       &   -                \\ \hline
schedules      &   x        &   x             &   T           &   -              &   -              &   -         &   x       &   -                \\ \hline
singleEdgeTest &   -        &   T             &   -           &   -              &   -              &   -         &   -       &   x                \\ \hline
unittests      &   T        &   x             &   x           &   -              &   x              &   -         &   -       &   x                \\ \hline
\end{tabular}
%\end{center}
\end{table}
\chapter{The Tests}
\section{bpcStart}
\texttt{bpcStart} tests the implementation of the beam process chain start flag in libcarpedm.
The test schedule sends two timing messages with \texttt{bpcstart=True} and \texttt{bpcstart=1}.
With \texttt{saft-ctl snoop} it is checked that the timing messages contain the correct setting.
In addition with \texttt{dm-sched} the dumped schedule is checked for the bpcstart flag.
\section{dmPerformance}
\texttt{dmPerformance} tests the performance improvements in libcarpedm.
The test starts a schedule on a clean data master, checks if some part of the schedule is removable, removes it and
then adds another schedule. This is done for a small schedule and a larger schedule. The test is ok if all commands
work. There is no check for this.
\section{dmThreads}
\texttt{dmThreads} tests the firmware with 4 threads. The same test for 6 threads fails due to a bug in the
firmware. For each thread a pattern with one block and one timing message is loaded.
\section{fid7}
\texttt{fid7} tests the fix for the format id 7 bug.
\include{full_test}
\section{messageCounter}
\texttt{messageCounter} is a basic test for the Python-Wrapper of libcarpedm.
\section{pps}
\texttt{pps} (pulse per second) is a basic test with a schedule which sends two timing messages every second.
\section{schedules}
\texttt{schedules} collects scheduls which are started. Tests that the schedules are compiled and loaded.
\include{singleEdgeTest}
\section{unittests}
\texttt{unittests} contains Python test scripts which contain Python unit tests for the tools dm-cmd, dm-sched. Each unit test calls dm-cmd
with commands and options and checks the result with the output on stdout and stderr. There are also negative tests with an invalid command
line. These tests are successful when the response is the correct error message and not a core dump.
\chapter{Common Components}
\section{dm\_testbench.py}
\texttt{dm\_testbench.py} is a collection of Python functions for use in other test scripts.
\begin{enumerate}
\item startpattern(data\_master, pattern\_file)
    Connect to the given data master and load the pattern file (dot format).
    The data master is halted, cleared, and statistics is reset.
    Search for the first pattern in the data master with 'dm-sched' and start it.
\end{enumerate}
\end{document}
